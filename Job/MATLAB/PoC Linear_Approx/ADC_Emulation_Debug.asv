clear
samplesize = 80;


voltage = zeros(samplesize);
current = zeros(samplesize);
RMSVoltage = 0;
RMSCurrent = 0;
VoltageLA = zeros(samplesize);
CurrentLA = zeros(samplesize);
Power  = zeros(samplesize);
RMSPower = 0;




% Using zero crossinger trigger
%voltage = [2714, 0, 1660, 0, 1640, 0, 1660, 0, 1679, 0, 1655, 0, 1674, 0, 1650, 0, 1669, 0, 1645, 0, 1665, 0, 1547, 0, 1660, 0, 1635, 0, 1655, 0, 1674, 0, 1650, 0, 1669, 0, 1650, 0, 1669, 0, 1645, 0, 1660, 0, 1640, 0, 1660, 0, 1635, 0, 1655, 0, 1674, 0, 1645, 0, 1669, 0, 1650, 0, 1665, 0, 1645, 0, 1665, 0, 1640, 0, 1655, 0, 1630, 0, 1650, 0, 1669, 0, 1645, 0, 1665]
%current = [0, 2436, 0, 2768, 0, 2749, 0, 2763, 0, 2778, 0, 2763, 0, 2778, 0, 2763, 0, 2773, 0, 2758, 0, 2773, 0, 2753, 0, 2768, 0, 2749, 0, 2768, 0, 2778, 0, 2983, 0, 2773, 0, 2988, 0, 2773, 0, 2988, 0, 2768, 0, 2988, 0, 2763, 0, 2983, 0, 2763, 0, 2973, 0, 2763, 0, 2963, 0, 2758, 0, 2949, 0, 2758, 0, 2934, 0, 2749, 0, 2915, 0, 2744, 0, 2895, 0, 2773, 0, 2866, 0];

% Free running interrupt]
%voltage = [2548, 0, 2949, 0, 2534, 0, 2905, 8, 1240, 0, 2275, 0, 2988, 0, 2299, 0, 1254, 0, 2514, 0, 2963, 0, 2060, 0, 1157, 0, 1606, 0, 2719, 0, 2861, 0, 1806, 0, 1835, 0, 2875, 0, 2695, 0, 1577, 0, 1171, 0, 2089, 0, 2973, 0, 2490, 0, 1376, 0, 1743, 0, 2988, 0, 2250, 0, 1230, 0, 1445, 0, 2568, 0, 2939, 0, 1997, 0, 1230, 0, 2763, 0, 2827, 0, 1748, 0, 1132, 0, 1894, 0, ]
%current = [0, 2812, 0, 2919, 0, 1953, 0, 1132, 0, 1684, 0, 2778, 0, 2797, 0, 1708, 0, 1928, 0, 2919, 0, 2622, 0, 1499, 0, 1206, 0, 2187, 0, 2988, 0, 2402, 0, 1313, 0, 2431, 0, 2978, 0, 2158, 0, 1191, 0, 1523, 0, 2646, 0, 2905, 0, 1904, 0, 1279, 0, 2822, 0, 2763, 0, 1660, 0, 1147, 0, 1992, 0, 2944, 0, 2578, 0, 1445, 0, 1655, 0, 2993, 0, 2348, 0, 1279, 0, 1372, 0, 2485]

% Free running, interurpt more often
%voltage = [2431, 0, 2846, 0, 2646, 0, 1606, 0, 1259, 0, 2128, 0, 2924, 0, 2456, 0, 1430, 0, 2358, 0, 2949, 0, 2241, 0, 1308, 0, 1528, 0, 2573, 0, 2895, 0, 2001, 0, 1728, 0, 2749, 0, 2783, 0, 1777, 0, 1225, 0, 1953, 0, 2875, 0, 2622, 0, 1567, 0, 1640, 0, 2939, 0, 2416, 0, 1401, 0, 1396, 0, 2412, 0, 2939, 0, 2192, 0, 1254, 0, 2617, 0, 2875, 0, 1958, 0, 1225, 0, 1772, 0, ];
%current = [0, 2783, 0, 2924, 0, 2138, 0, 1264, 0, 1601, 0, 2641, 0, 2846, 0, 1909, 0, 1806, 0, 2802, 0, 2724, 0, 1694, 0, 1240, 0, 2041, 0, 2910, 0, 2543, 0, 1499, 0, 2275, 0, 2949, 0, 2333, 0, 1347, 0, 1464, 0, 2495, 0, 2924, 0, 2099, 0, 1284, 0, 2685, 0, 2832, 0, 1865, 0, 1220, 0, 1855, 0, 2827, 0, 2690, 0, 1650, 0, 1567, 0, 2919, 0, 2500, 0, 1469, 0, 1342, 0, 2324, ];


% Free running, interrumpt more often, no zeros
%voltage = [2221, 1767, 1274, 1982, 2846, 2573, 1577, 1333, 2207, 2377, 1416, 1450, 2421, 2895, 2163, 1308, 1611, 2827, 1938, 1264, 1811, 2763, 2700, 1723, 1279, 2031, 2534, 1533, 1352, 2260, 2905, 2324, 1386, 1484, 2885, 2109, 1298, 1655, 2651, 2802];
%current = [1713, 1372, 1508, 2504, 1542, 1313, 2709, 2539, 1606, 2832, 2246, 2607, 2812, 2641, 1645, 1298, 2119, 2460, 1474, 1396, 2343, 2905, 2241, 1347, 1542, 2856, 2021, 1279, 1733, 2709, 2753, 1801, 1264, 1948, 2602, 1601, 1318, 2167, 2900, 2407];

%Free running, interupt more often, zeros
%voltage = [2778, 0, 2485, 0, 1489, 0, 1333, 0, 2255, 0, 2885, 0, 2280, 0, 1347, 0, 1469, 0, 2861, 0, 2060, 0, 1254, 0, 1650, 0, 2646, 0, 2768, 0, 1835, 0, 1230, 0, 1582, 0, 1284, 0, 2875, 0, 2402, 0, 1416, 0, 1386, 0, 2353, 0, 2880, 0, 2187, 0, 1298, 0, 2041, 0, 1639, 11, 1958, 0, 1240, 0, 1738, 0, 2714, 0, 2714, 0, 1738, 0, 1240, 0, 2827, 0, 2553, 0, 1542, 0, 1298, 0, ]
%current = [0, 2436, 0, 1972, 0, 1235, 0, 1723, 0, 2705, 0, 2719, 0, 1752, 0, 1235, 0, 2822, 0, 2563, 0, 1557, 0, 1293, 0, 2167, 0, 2880, 0, 2363, 0, 1396, 0, 2099, 0, 1269, 0, 2622, 0, 2788, 0, 1875, 0, 1230, 0, 1821, 0, 2768, 0, 2656, 0, 1660, 0, 1254, 0, 2861, 0, 2475, 0, 1479, 0, 1337, 0, 2270, 0, 2885, 0, 2270, 0, 1337, 0, 1958, 0, 2856, 0, 2045, 0, 1254, 0, 1660, ]

%free running, increased resolution lower prescaler
%voltage = [2060, 1303, 1220, 2148, 2983, 2470, 2744, 1640, 1518, 2631, 2929, 2998, 2294, 1279, 1459, 2568, 2958, 3002, 1787, 1171, 1914, 2915, 2714, 2885, 1865, 1166, 1835, 2875, 2978, 2519, 1420, 1303, 2348, 2021, 2954, 2587, 1474, 1264, 2783, 2519, 2973, 2104, 1201, 1616, 1367, 2446, 2993, 2177, 1206, 1171, 1787, 2846, 2768, 1674, 1459, 1274, 2788, 2817, 1748, 1166, 1191, 1625, 2734, 2866, 1826, 1577, 1210, 2124, 2978, 2485, 1391, 1650, 1191, 2055, 2963, 2558, 2309, 1284, 1455, 2553];
%current = [1577, 1210, 1586, 2690, 2895, 2998, 2216, 1196, 2075, 2968, 2543, 2797, 1708, 1176, 1997, 2949, 2773, 2841, 1318, 1401, 2495, 2983, 2988, 2446, 1367, 1347, 2421, 2656, 2919, 1943, 1166, 1757, 2832, 2592, 2949, 2021, 1186, 2270, 1938, 2919, 2661, 1547, 1230, 2187, 1865, 2890, 2714, 1606, 1547, 1323, 2377, 2998, 2255, 1259, 1181, 2290, 2998, 2338, 1298, 1513, 1235, 2202, 2993, 2846, 1791, 1166, 2407, 1337, 1372, 1860, 1166, 2866, 1171, 1748, 2822, 1230, 2172, 2993, 2636, 2919];

%free running, 4 prescale
%voltage = [1967, 1528, 1713, 1914, 2128, 2338, 2534, 2695, 2827, 2905, 2929, 2900, 2827, 2705, 2548, 2358, 2221, 2011, 1796, 1601, 1435, 1308, 1220, 1186, 1206, 1279, 1391, 1547, 1733, 1943, 2153, 2363, 2553, 2714, 2836, 2905, 2929, 2895, 2812, 2690, 2529, 2402, 2197, 1982, 1777, 1582, 1420, 1293, 1215, 1186, 1215, 1289, 1406, 1567, 1757, 1967, 2177, 2387, 2573, 2729, 2846, 2910, 2929, 2890, 2802, 2670, 2563, 2382, 2172, 1958, 1752, 1562, 1401, 1284, 1210, 1186, 1220, 1298, 1425, 1586, ]
%current = [2089, 1645, 1845, 2055, 2202, 2402, 2592, 2744, 2856, 2915, 2929, 2880, 2792, 2656, 2485, 2290, 2080, 1865, 1665, 1489, 1342, 1245, 1191, 1191, 1250, 1347, 1489, 1669, 1870, 2011, 2221, 2426, 2607, 2758, 2866, 2919, 2924, 2875, 2778, 2636, 2465, 2265, 2055, 1840, 1645, 1469, 1333, 1235, 1191, 1196, 1259, 1362, 1513, 1694, 1826, 2036, 2250, 2451, 2631, 2773, 2875, 2924, 2919, 2866, 2763, 2617, 2441, 2246, 2031, 1821, 1621, 1450, 1318, 1230, 1186, 1206, 1264, 1376, 1528, 1650, ]

%free running, 8 prescale
%voltage = [1440, 1210, 1313, 1494, 1738, 2011, 2294, 2553, 2753, 2880, 2919, 2871, 2729, 2519, 2260, 1977, 1708, 1469, 1298, 1206, 1201, 1289, 1464, 1694, 1967, 2250, 2514, 2724, 2866, 2924, 2885, 2758, 2558, 2304, 2026, 1752, 1503, 1323, 1215, 1196, 1269, 1425, 1650, 1923, 2202, 2470, 2695, 2851, 2919, 2895, 2783, 2597, 2348, 2070, 1791, 1542, 1342, 1225, 1191, 1254, 1401, 1616, 1875, 2158, 2431, 2661, 2832, 2915, 2905, 2807, 2631, 2392, 2119, 1835, 1577, 1372, 1240, 1191, 1235, 1367, ]
%current = [1523, 1254, 1396, 1611, 1875, 2153, 2426, 2661, 2827, 2915, 2905, 2807, 2631, 2397, 2124, 1840, 1582, 1372, 1240, 1191, 1240, 1367, 1572, 1826, 2109, 2387, 2626, 2807, 2905, 2915, 2832, 2666, 2436, 2167, 1884, 1621, 1406, 1254, 1191, 1220, 1342, 1533, 1782, 2065, 2343, 2592, 2783, 2895, 2919, 2851, 2700, 2475, 2211, 1933, 1665, 1435, 1274, 1196, 1210, 1318, 1503, 1738, 2016, 2294, 2553, 2758, 2885, 2919, 2866, 2729, 2519, 2255, 1977, 1704, 1469, 1293, 1206, 1201, 1293, 0, ]


% voltage = [2407, 3100, 2392, 1557, 913, 766, 1162, 1923, 2749, 3325, 3344, 2836, 2041, 1250, 771, 869, 1455, 2280, 3041, 3413, 3183, 2524, 1684, 991, 747, 1064, 1791, 2631, 3266, 3378, 2944, 2172, 1362, 815, 815, 1342, 2148, 2939, 3393, 3251, 2646, 1816, 1074, 747, 986, 1660, 2504, 3193, 3403, 3037, 2304, 1474, 869, 781, 1230, 2016, 2832, 3359, 3310, 2763, 1948, 1171, 756, 913, 1538, 2373, 3105, 3417, 3125, 2431, 1596, 937, 751, 1132, 1884, 2714, 3310, 3354, 2871, 2080, ]
% current = [2167, 2783, 1972, 1196, 761, 903, 1513, 2348, 3090, 3413, 3139, 2456, 1621, 952, 751, 1113, 1855, 2690, 3300, 3364, 2890, 2109, 1303, 791, 844, 1396, 2216, 2993, 3403, 3217, 2587, 1752, 1030, 742, 1025, 1723, 2568, 3232, 3393, 2993, 2241, 1416, 844, 800, 1284, 2084, 2885, 3378, 3281, 2705, 1884, 1123, 751, 952, 1601, 2436, 3149, 3408, 3081, 2368, 1538, 898, 766, 1181, 1948, 2773, 3334, 3334, 2817, 2016, 1225, 771, 883, 1474, 2309, 3061, 3413, 3164, 2500, 0, ]



%600mA (top)

voltage = [328.000000, 267.000000, 272.000000, 340.000000, 444.000000, 540.000000, 587.000000, 568.000000, 489.000000, 383.000000, 296.000000, 261.000000, 294.000000, 382.000000, 489.000000, 567.000000, 589.000000, 541.000000, 444.000000, 339.000000, 271.000000, 268.000000, 327.000000, 428.000000, 529.000000, 584.000000, 574.000000, 502.000000, 397.000000, 304.000000, 261.000000, 285.000000, 368.000000, 474.000000, 559.000000, 590.000000, 550.000000, 460.000000, 353.000000, 278.000000, 263.000000, 315.000000, 414.000000, 516.000000, 581.000000, 580.000000, 515.000000, 411.000000, 314.000000, 264.000000, 279.000000, 355.000000, 460.000000, 551.000000, 589.000000, 559.000000, 473.000000, 366.000000, 284.000000, 262.000000, 305.000000, 400.000000, 504.000000, 575.000000, 585.000000, 527.000000, 426.000000, 325.000000, 267.000000, 273.000000, 343.000000, 446.000000, 542.000000, 588.000000, 566.000000, 486.000000, 381.000000, 294.000000, 260.000000, 295.000000, ];
current3 = [400.000000, 289.000000, 236.000000, 261.000000, 354.000000, 477.000000, 579.000000, 616.000000, 574.000000, 471.000000, 349.000000, 258.000000, 237.000000, 295.000000, 407.000000, 527.000000, 605.000000, 607.000000, 535.000000, 417.000000, 302.000000, 239.000000, 253.000000, 339.000000, 461.000000, 569.000000, 616.000000, 584.000000, 487.000000, 364.000000, 266.000000, 235.000000, 284.000000, 390.000000, 512.000000, 599.000000, 613.000000, 548.000000, 434.000000, 316.000000, 243.000000, 247.000000, 325.000000, 444.000000, 557.000000, 615.000000, 592.000000, 502.000000, 381.000000, 277.000000, 234.000000, 273.000000, 374.000000, 497.000000, 591.000000, 616.000000, 561.000000, 451.000000, 330.000000, 249.000000, 241.000000, 311.000000, 428.000000, 543.000000, 611.000000, 601.000000, 518.000000, 397.000000, 287.000000, 235.000000, 263.000000, 358.000000, 480.000000, 581.000000, 617.000000, 572.000000, 467.000000, 345.000000, 256.000000, 238.000000, ];

%100 ish mA (low)
voltage = [585.000000, 526.000000, 424.000000, 323.000000, 264.000000, 272.000000, 344.000000, 449.000000, 544.000000, 589.000000, 566.000000, 483.000000, 377.000000, 291.000000, 260.000000, 296.000000, 388.000000, 494.000000, 571.000000, 589.000000, 537.000000, 438.000000, 334.000000, 269.000000, 267.000000, 332.000000, 435.000000, 534.000000, 587.000000, 573.000000, 497.000000, 391.000000, 301.000000, 260.000000, 288.000000, 374.000000, 481.000000, 564.000000, 591.000000, 547.000000, 452.000000, 348.000000, 274.000000, 263.000000, 320.000000, 420.000000, 523.000000, 582.000000, 579.000000, 510.000000, 406.000000, 309.000000, 261.000000, 280.000000, 360.000000, 467.000000, 556.000000, 591.000000, 555.000000, 466.000000, 360.000000, 280.000000, 260.000000, 309.000000, 406.000000, 511.000000, 579.000000, 584.000000, 522.000000, 420.000000, 321.000000, 264.000000, 274.000000, 348.000000, 452.000000, 546.000000, 590.000000, 563.000000, 480.000000, 373.000000, ];
current = [465.000000, 451.000000, 426.000000, 400.000000, 385.000000, 386.000000, 403.000000, 429.000000, 454.000000, 465.000000, 460.000000, 441.000000, 414.000000, 392.000000, 382.000000, 391.000000, 414.000000, 441.000000, 460.000000, 466.000000, 454.000000, 430.000000, 403.000000, 386.000000, 385.000000, 400.000000, 425.000000, 450.000000, 465.000000, 462.000000, 444.000000, 418.000000, 395.000000, 382.000000, 390.000000, 410.000000, 436.000000, 459.000000, 466.000000, 456.000000, 433.000000, 406.000000, 388.000000, 384.000000, 397.000000, 422.000000, 447.000000, 464.000000, 464.000000, 447.000000, 421.000000, 397.000000, 383.000000, 388.000000, 407.000000, 433.000000, 456.000000, 466.000000, 458.000000, 436.000000, 410.000000, 390.000000, 384.000000, 394.000000, 418.000000, 444.000000, 463.000000, 465.000000, 450.000000, 425.000000, 400.000000, 385.000000, 386.000000, 403.000000, 430.000000, 454.000000, 466.000000, 460.000000, 440.000000, 413.000000, ];







voltage = ((voltage * 5000/1024) - 2070) / (0.04347 * 0.95);
%voltage = ((voltage-2060)*20.95);
current = ((current * 5000/1024) - (2070)) / (0.6 * 1.8);


time = 1:length(voltage);
time2 = 1:length(voltage)*2;

voltageLCalc = Proper_Implementation_V(voltage);
currentLCalc = Proper_Implementation_C(current);


interlacedVcalc = interlaceVoltage(voltage, voltageLCalc);
interlacedCcalc = interlaceCurrent(currentLCalc, current);

interlacedCcalcTest = interlacedCcalc * 120;

interlacedRealV = interlaceVoltage(voltage, VoltageLA);
interlacedRealC = interlaceCurrent(CurrentLA, current);


RMSVoltageCalc = RMSCalc(voltage)
RMSCurrentCalc = RMSCalc(current)

testPower = RMSVoltageCalc * RMSCurrentCalc;

RMSPowerCalc = RMSPowerf(voltage, VoltageLA, current, CurrentLA);

powergraph = interlacedVcalc/1000 .* interlacedCcalc/1000;

scaler = 1 - (((RMSCurrentCalc/ 132.0861)/20)) 

% RMSPowerEstimate = RMSPowerSecond(powergraph) * scaler
RMSPowerEstimate = RMSVoltageCalc * RMSCurrentCalc * scaler /(1000*1000)

tiledlayout(4,1)
%VOLTAGE PORTION___________________________
%standard voltage
% nexttile
% plot(time, voltage, 'ro')
% title('voltage.mc')

% nexttile
% plot(time, voltage, 'ro', time, voltage123, 'bo')
% title('voltage.mc + voltage123')
% legend("Voltage","Voltage123");
% 
% nexttile
% plot(time, current, 'ro', time, current123, 'bo')
% title('current.mc + current 123')
% legend("Current","Current123");

%LA Calculation voltage
%nexttile
% nexttile
% plot(time, voltageLCalc, 'ro')
% title('voltageLA.calc')


%LA from mc
%nexttile
% plot(time, VoltageLA, 'ro')
% title('voltageLA.mc')


%real and Calculated LA combined voltage
nexttile
plot(time2, interlacedVcalc, 'ro')
title('voltage + voltageLA.calc')


%combine real and LA voltage from mu
%nexttile
% plot(time2, interlacedRealV, 'go')
% title('voltage + voltageLA.mc')


%CURRENT PORTION________________________
%standard current
% nexttile
% plot(time, current, 'ro')
% title('current.mc')
% 
% 
% %LA Calculation current
% nexttile
% plot(time, currentLCalc, 'ro')
% title('currentLA.calc')


%LA from mc
% nexttile
% plot(time, CurrentLA, 'ro')
% title('currentLA.mc')


%real and Calculated LA combined current
nexttile
plot(time2, interlacedCcalc, 'ro')
title('current + currentLA.calc')

%Estimate power graph
nexttile
plot(time2, powergraph, 'bo')
title('power graph estimate')


%Estimate power graph
nexttile
plot(time2, interlacedVcalc, 'bo', time2, interlacedCcalcTest, 'ro');
title('Voltage vs Current')
legend("Voltage","Current");
%real and  LA combined current
%nexttile
% plot(time2, interlacedRealC, 'ro')
% title('current + currentLA.mc')



%nexttile
% plot(time2, testPower, 'bo')
% title("power test")

% nexttile
% plot(time, voltage, 'bo', time, current, 'go')
% title("power guess")
% legend("Voltage","Current");


